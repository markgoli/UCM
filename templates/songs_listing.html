{% extends 'base.html' %}
{% load static %}

{% block title %}Music Score Catalog - UCM{% endblock %}

{% block content %}

<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<section class="bg-[#fcfcfb] min-h-screen py-16 px-6 lg:px-16" hx-boost="true">
    
    <div class="max-w-[1600px] mx-auto mb-16">
        <div class="flex flex-col md:flex-row justify-between items-end gap-8">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-[1px] bg-indigo-600"></div>
                    <span class="text-[10px] uppercase tracking-[0.4em] font-black text-slate-400">Institutional Repository</span>
                </div>
                <!-- <h1 class="serif text-5xl text-slate-900">Music Scores <span class="italic text-slate-500">Archive</span></h1> -->
                <p class="serif text-2xl text-slate-600 tracking-widest">The most downloaded scores by our global community.</p>
            </div>

            <div class="w-full md:w-1/3 group border-b border-slate-400 focus-within:border-slate-950 transition-all py-2 flex items-center gap-4">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" name="q" id="songSearch" 
                    hx-get="{% url 'song_library' %}" 
                    hx-target="#songGrid" 
                    hx-swap="outerHTML"
                    hx-trigger="keyup changed delay:500ms"
                    hx-indicator=".htmx-indicator"
                    placeholder="Search Title or Composer..." 
                    class="bg-transparent border-none outline-none text-sm w-full text-slate-900 placeholder:text-slate-500">
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-16">
        
        <aside class="lg:col-span-3 space-y-12">
            <form id="filterForm" hx-get="{% url 'song_library' %}" hx-target="#songGrid" hx-swap="outerHTML" hx-trigger="change" hx-push-url="true">
                
                <div class="flex items-center justify-between mb-8 border-b border-slate-400 pb-2">
                    <h3 class="text-[11px] uppercase tracking-[0.3em] font-black text-slate-900">Filters</h3>
                    <button type="button" 
                        onclick="resetFilters()"
                        class="text-[9px] uppercase tracking-widest font-bold text-indigo-600 hover:text-slate-900 transition-colors">
                        Clear All
                    </button>
                </div>

                <div class="mb-10">
                    <h4 class="text-[9px] uppercase tracking-[0.2em] font-black text-slate-500 mb-6">Liturgical Season</h4>
                    <div class="space-y-3">
                        {% for value, label in season_choices %}
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="season" value="{{ value }}" class="filter-checkbox w-4 h-4 border-slate-200 rounded-none transition-all">
                            <span class="text-[11px] uppercase tracking-widest text-slate-700 group-hover:text-slate-900">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <h4 class="text-[9px] uppercase tracking-[0.2em] font-black text-slate-400 mb-6">Part of Mass</h4>
                    <div class="space-y-3 max-h-80 overflow-y-auto pr-4 custom-scrollbar">
                        {% for value, label in mass_parts %}
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="part" value="{{ value }}" class="filter-checkbox w-4 h-4 border-slate-200 rounded-none transition-all">
                            <span class="text-[11px] uppercase tracking-widest text-slate-500 group-hover:text-slate-900">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </aside>

        <div class="lg:col-span-9 relative">
            <div class="htmx-indicator absolute -top-8 left-0 flex items-center gap-2">
               <div class="animate-spin h-3 w-3 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
               <span class="text-[9px] uppercase tracking-widest font-bold text-slate-400">Refreshing Archive...</span>
            </div>
            
            {% include 'partials/song_grid.html' %}
        </div>
    </div>
</section>

<script>
    function resetFilters() {
        const form = document.getElementById('filterForm');
        const searchInput = document.getElementById('songSearch');
        
        // Reset form inputs
        form.reset();
        searchInput.value = '';
        
        // Trigger HTMX to refresh the grid with empty params
        htmx.ajax('GET', '{% url "song_library" %}', {target:'#songGrid', swap: 'outerHTML', pushUrl: true});
    }
</script>

<script>
    let activeAudio = null;
    let activeBtn = null;

    function navigateToDetails(card) {
        const url = card.getAttribute('data-detail-url');
        if (url) window.location.href = url;
    }

    function handleAudioPlay(event, btn, audioId) {
        event.stopPropagation(); // Prevents navigating to details page
        
        const audio = document.getElementById(audioId);
        const playIcon = btn.querySelector('[id^="play-icon"]');
        const pauseIcon = btn.querySelector('[id^="pause-icon"]');

        // Stop previous audio if playing a new one
        if (activeAudio && activeAudio !== audio) {
            activeAudio.pause();
            activeAudio.currentTime = 0;
            activeBtn.querySelector('[id^="play-icon"]').classList.remove('hidden');
            activeBtn.querySelector('[id^="pause-icon"]').classList.add('hidden');
        }

        if (audio.paused) {
            audio.play();
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            activeAudio = audio;
            activeBtn = btn;
        } else {
            audio.pause();
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            activeAudio = null;
        };
    }
</script>

{% endblock %}