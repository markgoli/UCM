{% extends 'base.html' %}
{% load static %}

{% block title %}Music Score Catalog - UCM{% endblock %}

{% block content %}

<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<section class="bg-[#fcfcfb] min-h-screen py-16 px-6 lg:px-16" hx-boost="true">
    
    <div class="max-w-[1600px] mx-auto mb-16">
        <div class="flex flex-col md:flex-row justify-between items-end gap-8">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-[1px] bg-indigo-600"></div>
                    <span class="text-[10px] uppercase tracking-[0.4em] font-black text-slate-400">Institutional Repository</span>
                </div>
                <!-- <h1 class="serif text-5xl text-slate-900">Music Scores <span class="italic text-slate-500">Archive</span></h1> -->
                <p class="serif text-2xl text-slate-600 tracking-widest">The most downloaded scores by our global community.</p>
            </div>

            <div class="w-full md:w-1/3 group border-b border-slate-400 focus-within:border-slate-950 transition-all py-2 flex items-center gap-4">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" name="q" id="songSearch" 
                    hx-get="{% url 'song_library' %}" 
                    hx-target="#songGrid" 
                    hx-swap="outerHTML"
                    hx-trigger="keyup changed delay:500ms"
                    hx-indicator=".htmx-indicator"
                    placeholder="Search Title or Composer..." 
                    class="bg-transparent border-none outline-none text-sm w-full text-slate-900 placeholder:text-slate-500">
            </div>

            <div>
                <a href="{% url 'song_links' %}">
                    <button class="bg-white text-slate-900 px-6 py-2.5 rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-indigo-50 transition-all active:scale-95">
                        All Hymns
                    </button>
                </a>
            </div>
                
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-16">
        
        <div class="lg:hidden">
            <button onclick="toggleFilters()" 
                    class="w-full py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-[0.3em] flex items-center justify-center gap-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
                Filter Archive
            </button>
        </div>
        
        <aside id="filterSidebar" class="hidden lg:block lg:col-span-3 space-y-12 bg-[#fcfcfb] lg:bg-transparent p-6 lg:p-0 border lg:border-none border-slate-200 mb-8 lg:mb-0">
    
            <form id="filterForm" hx-get="{% url 'song_library' %}" hx-target="#songGrid" hx-swap="outerHTML" hx-trigger="change" hx-push-url="true">
                
                <div class="flex items-center justify-between mb-8 border-b border-slate-400 pb-2">
                    <h3 class="text-[10px] lg:text-[11px] uppercase tracking-[0.3em] font-black text-slate-900">Filters</h3>
                    <div class="flex items-center gap-4">
                        <button type="button" 
                            onclick="resetFilters()"
                            class="text-[8px] lg:text-[9px] uppercase tracking-widest font-bold text-indigo-600 hover:text-slate-900 transition-colors">
                            Clear All
                        </button>
                        <button type="button" onclick="toggleFilters()" class="lg:hidden text-slate-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg>
                        </button>
                    </div>
                </div>
        
                <div class="mb-10">
                    <h4 class="text-[8px] lg:text-[9px] uppercase tracking-[0.2em] font-black text-slate-500 mb-6">Liturgical Season</h4>
                    <div class="grid grid-cols-2 lg:grid-cols-1 gap-x-4 gap-y-3">
                        {% for value, label in season_choices %}
                        <label class="flex items-center gap-2 lg:gap-3 cursor-pointer group">
                            <input type="checkbox" name="season" value="{{ value }}" 
                                class="filter-checkbox w-3.5 h-3.5 lg:w-4 lg:h-4 border-slate-200 rounded-none checked:bg-indigo-600 transition-all">
                            <span class="text-[10px] lg:text-[11px] uppercase tracking-widest text-slate-700 group-hover:text-slate-900 leading-none">
                                {{ label }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
        
                <div>
                    <h4 class="text-[8px] lg:text-[9px] uppercase tracking-[0.2em] font-black text-slate-400 mb-6">Part of Mass</h4>
                    <div class="max-h-80 overflow-y-auto pr-4 custom-scrollbar grid grid-cols-2 lg:grid-cols-1 gap-x-4 gap-y-3">
                        {% for value, label in mass_parts %}
                        <label class="flex items-center gap-2 lg:gap-3 cursor-pointer group">
                            <input type="checkbox" name="part" value="{{ value }}" 
                                class="filter-checkbox w-3.5 h-3.5 lg:w-4 lg:h-4 border-slate-200 rounded-none checked:bg-indigo-600 transition-all">
                            <span class="text-[10px] lg:text-[11px] uppercase tracking-widest text-slate-500 group-hover:text-slate-900 leading-none">
                                {{ label }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </aside>

        <div class="lg:col-span-9 relative">
            <div class="htmx-indicator absolute -top-8 left-0 flex items-center gap-2">
               <div class="animate-spin h-3 w-3 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
               <span class="text-[9px] uppercase tracking-widest font-bold text-slate-400">Refreshing Archive...</span>
            </div>
            
            {% include 'partials/song_grid.html' %}
        </div>
    </div>
</section>

<script>
    function toggleFilters() {
        const sidebar = document.getElementById('filterSidebar');
        if (sidebar.classList.contains('hidden')) {
            sidebar.classList.remove('hidden');
            // Optional: Scroll to top of filters when opened
            sidebar.scrollIntoView({ behavior: 'smooth' });
        } else {
            sidebar.classList.add('hidden');
        }
    }
</script>

<script>
    function resetFilters() {
        const form = document.getElementById('filterForm');
        const searchInput = document.getElementById('songSearch');
        
        // Reset form inputs
        form.reset();
        searchInput.value = '';
        
        // Trigger HTMX to refresh the grid with empty params
        htmx.ajax('GET', '{% url "song_library" %}', {target:'#songGrid', swap: 'outerHTML', pushUrl: true});
    }
</script>

<script>
    let activeAudio = null;
    let activeBtn = null;

    function navigateToDetails(card) {
        const url = card.getAttribute('data-detail-url');
        if (url) window.location.href = url;
    }

    function handleAudioPlay(event, btn, audioId) {
        event.stopPropagation(); // Prevents navigating to details page
        
        const audio = document.getElementById(audioId);
        const playIcon = btn.querySelector('[id^="play-icon"]');
        const pauseIcon = btn.querySelector('[id^="pause-icon"]');

        // Stop previous audio if playing a new one
        if (activeAudio && activeAudio !== audio) {
            activeAudio.pause();
            activeAudio.currentTime = 0;
            activeBtn.querySelector('[id^="play-icon"]').classList.remove('hidden');
            activeBtn.querySelector('[id^="pause-icon"]').classList.add('hidden');
        }

        if (audio.paused) {
            audio.play();
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            activeAudio = audio;
            activeBtn = btn;
        } else {
            audio.pause();
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            activeAudio = null;
        };
    }
</script>

{% endblock %}