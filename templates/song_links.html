{% extends 'base.html' %}

{% block content %}
<section class="bg-[#fcfcfb] min-h-screen p-8 lg:p-16">
    <div class="max-w-7xl mx-auto mb-12 border-b border-slate-200 pb-8 flex flex-col md:flex-row justify-between items-end gap-6">
        <div>
            <span class="text-indigo-600 text-[10px] uppercase tracking-[0.4em] font-black mb-2 block">Archive Index</span>
            <h1 class="serif text-5xl text-slate-900">Manuscript Downloads</h1>
        </div>

        <div class="w-full md:w-1/3 group border-b border-slate-400 focus-within:border-slate-950 transition-all py-2 flex items-center gap-4">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" name="q" id="indexSearch" 
                placeholder="Filter manuscripts by title..."
                onkeyup="filterIndex()"
                class="bg-transparent border-none outline-none text-sm w-full text-slate-900 placeholder:text-slate-500">
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div id="songContainer" class="columns-1 md:columns-2 lg:columns-3 gap-12 space-y-8">
            
            {% for song in songs %}
            <div class="song-item break-inside-avoid mb-8 pb-4 border-b border-slate-100 group">
                <h3 class="song-title text-sm font-black uppercase tracking-tight text-slate-900 mb-2 group-hover:text-indigo-600 transition-colors">
                    {{ song.title }}
                </h3>
                
                <div class="space-y-2">
                    {% with sheets=song.musicsheet_set.all %}
                        {% if sheets %}
                            {% for sheet in sheets %}
                            <a href="{% url 'download_sheet' sheet.id %}" 
                               class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl hover:border-indigo-400 hover:shadow-md transition-all group/link">
                                <div class="flex items-center gap-3">
                                    <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                    <span class="text-[11px] font-bold text-slate-600 uppercase">{{ sheet.ms_version }}</span>
                                </div>
                                <svg class="w-4 h-4 text-slate-300 group-hover/link:text-indigo-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </a>
                            {% endfor %}
                        {% else %}
                            <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-xl border border-amber-100">
                                <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                                <span class="text-[10px] font-black uppercase text-amber-600">No Manuscript Found</span>
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            {% endfor %}

        </div>

        <div id="noResults" class="hidden py-20 text-center">
            <p class="serif text-3xl text-slate-300 italic">No manuscripts match your filter.</p>
        </div>
    </div>
</section>

<script>
    function filterIndex() {
        const input = document.getElementById('indexSearch');
        const filter = input.value.toUpperCase();
        const container = document.getElementById('songContainer');
        const items = container.getElementsByClassName('song-item');
        const noResults = document.getElementById('noResults');
        let visibleCount = 0;

        for (let i = 0; i < items.length; i++) {
            const title = items[i].getElementsByClassName('song-title')[0];
            const textValue = title.textContent || title.innerText;
            
            if (textValue.toUpperCase().indexOf(filter) > -1) {
                items[i].style.display = "";
                visibleCount++;
            } else {
                items[i].style.display = "none";
            }
        }

        // Handle empty state
        if (visibleCount === 0) {
            container.classList.add('hidden');
            noResults.classList.remove('hidden');
        } else {
            container.classList.remove('hidden');
            noResults.classList.add('hidden');
        }
    }
</script>
{% endblock %}