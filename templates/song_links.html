{% extends 'base.html' %}

{% block content %}
<section class="bg-[#fcfcfb] min-h-screen p-8 lg:p-16">
    <div class="max-w-7xl mx-auto mb-12 border-b border-slate-200 pb-8 flex flex-col md:flex-row justify-between items-end gap-6">
        <div>
            <span class="text-indigo-600 text-[10px] uppercase tracking-[0.4em] font-black mb-2 block">Archive Index</span>
            <h1 class="serif text-5xl text-slate-900">Manuscript Downloads</h1>
        </div>

        <div class="w-full md:w-1/3 group border-b border-slate-400 focus-within:border-slate-950 transition-all py-2 flex items-center gap-4">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" name="q" id="indexSearch" 
                placeholder="Filter manuscripts by title..."
                onkeyup="filterIndex()"
                class="bg-transparent border-none outline-none text-sm w-full text-slate-900 placeholder:text-slate-500">
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div id="songContainer" class="columns-1 md:columns-2 lg:columns-3 gap-16 space-y-2">
            
            {% for song in songs %}
                {% with sheets=song.musicsheet_set.all %}
                    {% if sheets %}
                        {% for sheet in sheets %}
                        <div class="song-item break-inside-avoid leading-relaxed">
                            <a href="{% url 'download_sheet' sheet.id %}" 
                               class="group flex items-center py-1 outline-none">
                                
                                <h3 class="song-title text-[10px] font-black uppercase tracking-tight text-slate-800 group-hover:text-indigo-600 transition-colors">
                                    {{ song.title }} â€” {{ sheet.ms_version }}
                                </h3>
    
                                <span class="ml-2 w-1 h-1 rounded-full bg-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"></span>
                            </a>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            {% endfor %}
    
        </div>
    
        <div id="noResults" class="hidden py-24 text-center">
            <p class="serif text-2xl text-slate-300 italic">No matching records found in the index.</p>
        </div>
    </div>

</section>

<script>
    function filterIndex() {
        const input = document.getElementById('indexSearch');
        const filter = input.value.toUpperCase();
        const container = document.getElementById('songContainer');
        const items = container.getElementsByClassName('song-item');
        const noResults = document.getElementById('noResults');
        let visibleCount = 0;

        for (let i = 0; i < items.length; i++) {
            const title = items[i].getElementsByClassName('song-title')[0];
            const textValue = title.textContent || title.innerText;
            
            if (textValue.toUpperCase().indexOf(filter) > -1) {
                items[i].style.display = "";
                visibleCount++;
            } else {
                items[i].style.display = "none";
            }
        }

        // Handle empty state
        if (visibleCount === 0) {
            container.classList.add('hidden');
            noResults.classList.remove('hidden');
        } else {
            container.classList.remove('hidden');
            noResults.classList.add('hidden');
        }
    }
</script>
{% endblock %}